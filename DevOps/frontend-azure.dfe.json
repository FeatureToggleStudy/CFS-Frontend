{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "environmentKey": {
      "type": "string",
      "metadata": {
        "description": "The environment key for this particular environment eg t1dv"
      }
    },
    "frontendDomain": {
      "type": "string",
      "metadata": {
        "description": "The domain name for the front end webserver"
      }
    },
    "skuName": {
      "type": "string",
      "defaultValue": "S1",
      "allowedValues": [
        "F1",
        "D1",
        "B1",
        "B2",
        "B3",
        "S1",
        "S2",
        "S3",
        "P1",
        "P2",
        "P3",
        "P4"
      ],
      "metadata": {
        "description": "Describes plan's pricing tier and instance size. Check details at https://azure.microsoft.com/en-us/pricing/details/app-service/"
      }
    },
    "skuCapacity": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "metadata": {
        "description": "Describes plan's instance count"
      }
    },
    "apiKey": {
      "type": "string",
      "metadata": {
        "description": "Calculate Funding API Management Key"
      }
    },
    "apiEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Calculate Funding API Management Endpoint"
      }
    },
    "aadDomain": {
      "type": "string",
      "metadata": {
        "description": "Domain name for ad application"
      }
    },
    "aadTenantId": {
      "type": "string",
      "metadata": {
        "description": "Tenant id of ad application"
      }
    },
    "aadClientId": {
      "type": "string",
      "metadata": {
        "description": "Client id of ad application"
      }
    },
    "aadInstance": {
      "type": "string",
      "metadata": {
        "description": "AD instance url for application"
      }
    },
    "aadGroups": {
      "type": "string",
      "metadata": {
        "description": "AD groups"
      }
    },
    "aadEnabled": {
      "type": "string",
      "metadata": {
        "description": "Enable authentication"
      },
      "defaultValue": "true"
    }
  },
  "variables": {
    "hostingPlanName": "[concat('asp-', parameters('environmentKey'), '-cfs01')]",
    "webSiteName": "[concat('app-', parameters('environmentKey'), '-cfs01')]",
    "applicationInsightsName": "[concat('ai-', parameters('environmentKey'), '-cfs')]",
    "frontEndCertificateName": "frontendcert"
  },
  "resources": [
    {
      "apiVersion": "2016-03-01",
      "name": "[variables('hostingPlanName')]",
      "type": "Microsoft.Web/serverfarms",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "HostingPlan"
      },
      "sku": {
        "name": "[parameters('skuName')]",
        "capacity": "[parameters('skuCapacity')]"
      },
      "properties": {
        "name": "[variables('hostingPlanName')]"
      }
    },
    {
      "apiVersion": "2016-03-01",
      "name": "[variables('webSiteName')]",
      "type": "Microsoft.Web/sites",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[variables('hostingPlanName')]",
        "[variables('applicationInsightsName')]"
      ],
      "tags": {
        "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName')))]": "empty",
        "displayName": "Website"
      },
      "resources": [
        {
          "apiVersion": "2016-03-01",
          "name": "Microsoft.ApplicationInsights.AzureWebSites",
          "type": "siteextensions",
          "dependsOn": [
            "[resourceId('Microsoft.Web/Sites', variables('webSiteName'))]"
          ],
          "properties": {}
        }
      ],
      "properties": {
        "name": "[variables('webSiteName')]",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "siteConfig": {
          "AlwaysOn": true,
          "use32BitWorkerProcess": false,
          "http20Enabled": true,
          "phpVersion": "",
          "pythonVersion": "",
          "nodeVersion": "",
          "httpsOnly": true,
          "minTlsVersion": "1.2",
          "ftpsState": "Disabled",
          "ipSecurityRestrictions": [
            {
              "ipAddress": "213.123.63.150"
            },
            {
              "ipAddress": "86.188.174.157"
            }
          ],
          "appSettings": [
            {
              "name": "ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "ApiEndpoint",
              "value": "[parameters('apiEndpoint')]"
            },
            {
              "name": "specsClient:ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "specsClient:ApiEndpoint",
              "value": "[concat('https://app-', parameters('environmentKey'), '-specs.azurewebsites.net/api/specs')]"
            },
            {
              "name": "calcsClient:ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "calcsClient:ApiEndpoint",
              "value": "[concat('https://app-', parameters('environmentKey'), '-calcs.azurewebsites.net/api/calcs')]"
            },
            {
              "name": "datasetsClient:ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "datasetsClient:ApiEndpoint",
              "value": "[concat('https://app-', parameters('environmentKey'), '-datasets.azurewebsites.net/api/datasets')]"
            },
            {
              "name": "resultsClient:ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "resultsClient:ApiEndpoint",
              "value": "[concat('https://app-', parameters('environmentKey'), '-results.azurewebsites.net/api/results')]"
            },
            {
              "name": "scenariosClient:ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "scenariosClient:ApiEndpoint",
              "value": "[concat('https://app-', parameters('environmentKey'), '-scenarios.azurewebsites.net/api/scenarios')]"
            },
            {
              "name": "testEngineClient:ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "testEngineClient:ApiEndpoint",
              "value": "[concat('https://app-', parameters('environmentKey'), '-testengine.azurewebsites.net/api/tests')]"
            },
            {
              "name": "usersClient:ApiKey",
              "value": "[parameters('apiKey')]"
            },
            {
              "name": "usersClient:ApiEndpoint",
              "value": "[concat('https://app-', parameters('environmentKey'), '-users.azurewebsites.net/api/users')]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2014-04-01').InstrumentationKey]"
            },
            {
              "name": "ApplicationInsightsOptions:InstrumentationKey",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2014-04-01').InstrumentationKey]"
            },
            {
              "name": "AzureAd:Instance",
              "value": "[parameters('aadInstance')]"
            },
            {
              "name": "AzureAd:CallbackPath",
              "value": "/signin-oidc"
            },
            {
              "name": "AzureAd:Domain",
              "value": "[parameters('aadDomain')]"
            },
            {
              "name": "AzureAd:TenantId",
              "value": "[parameters('aadTenantId')]"
            },
            {
              "name": "AzureAd:ClientId",
              "value": "[parameters('aadClientId')]"
            },
            {
              "name": "AzureAd:Groups",
              "value": "[parameters('aadGroups')]"
            },
            {
              "name": "AzureAd:IsEnabled",
              "value": "[parameters('aadEnabled')]"
            }
          ]
        }
      }
    },
    {
      "apiVersion": "2015-05-01",
      "name": "[variables('applicationInsightsName')]",
      "type": "Microsoft.Insights/components",
      "location": "[resourceGroup().location]",
      "properties": {}
    }
  ],
  "outputs": {
    "siteUri": {
      "type": "string",
      "value": "[reference(concat('Microsoft.Web/sites/', variables('webSiteName'))).hostnames[0]]"
    }
  }
}