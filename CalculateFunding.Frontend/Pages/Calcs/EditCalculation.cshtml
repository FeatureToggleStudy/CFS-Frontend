@page "{calculationId}"
@model CalculateFunding.Frontend.Pages.Calcs.EditCalculationPageModel
@using CalculateFunding.Frontend.Properties
@using CalculateFunding.Frontend.Helpers
@{
    ViewData["Title"] = "Edit Calculation";
    Layout = "~/Pages/_Layout.cshtml";
}

@section FormBannerLeft{
    <p class="hero-title">@Model.Calculation.Name for @Model.Calculation.PeriodName</p>
    <div>
        <p class="what-is-title-nojs withjs-hide">What is @Model.Calculation.Name?</p>

        <div class="inline-collapse-container">
            <div class="inline-collapse-heading withjs-show">
                <i class="inline-collapse-arrow"></i>
                <span>What is @Model.Calculation.Name?</span>
            </div>
            <div class="inline-collapse-contents withjs-hide what-is-description">
                @Model.Calculation.Description
            </div>
        </div>
    </div>
}

@section FormBannerRight{
    <div class="bannerpublish-container">
        <div class="bannerpublish-title">Status</div>
        <div class="bannerpublish-status"><strong>Status:</strong> @Model.Calculation.Status</div>
        <div class="bannerpublish-lastmodifiedby">Last saved by: @Model.Calculation.LastModifiedByName</div>
        <div class="bannerpublish-lastmodified">@Model.Calculation.LastModified.ToString(FormatStrings.DateTimeFormatString)</div>
        <div class="bannerpublish-button-container"><input type="button" value="Publish" class="button button-publish" disabled id="publish-button" /></div>
    </div>
}

@section BreadCrumb{
    <div class="breadcrumbs">
        <ol>
            <li><a href="/">@BreadcrumbText.CalculateFunding</a></li>
            <li><a href="/calcs">@BreadcrumbText.ManageCalculations</a></li>
            <li>@Model.Calculation.Name</li>
        </ol>
    </div>
}
<div class="row">
    <div class="col-xs-12 edit-calculation" id="edit-calculation">
        <strong>Calculation script:</strong>
        <div id="monacoeditor" class="monaco-editor-container" data-bind="monacoEditor: sourceCode, monacoEditorOptions: {editorCreatedCallback: registerMonacoProviders}"></div>

        <div>
            <a href="/calcs/compare/@Model.Calculation.Id" id="view-previous-versions-button">View previous versions</a>
        </div>

        <div class="spacing-30">
            <input type="button" class="button" value="Build calculation" data-bind="click: buildCalculation, disable: !canBuildCalculation()" id="build-calculation-button" />
        </div>

        <strong>Build output:</strong>

        <div class="build-output">
            <div data-bind="text: buildOutput"></div>
            <div data-bind="with: compilerResponse" id="compiler-response">
                Code compiled successfully: <span data-bind="text: compilerOutput.success"></span>

                <div class="compiler-messages" data-bind="foreach: compilerOutput.compilerMessages">
                    <span data-bind="text: severity"></span>: <span data-bind="text: message"></span>
                </div>
            </div>
        </div>

        <div class="spacing-30" data-bind="visible: !calculationBuilt()">Please build calculation before saving the calculation:</div>
        <div class="spacing-15">
            <input type="button" class="button" value="Save calculation" data-bind="click: saveCalculation, enable: canSaveCalculation" id="save-calculation-button" />
        </div>

        <div class="spacing-15" data-bind="visible: saveCalculationResult, text: saveCalculationResult"></div>

        <div>
            <a href="/calcs" id="link-back">Back</a>
        </div>
    </div>
</div>

@section scripts{
    <script asp-src-include="~/assets/libs/js/knockout-latest.js" type="text/javascript" asp-append-version="true"></script>
    <script asp-src-include="~/regex.js" type="text/javascript" asp-append-version="true"></script>
    <script asp-src-include="~/assets/libs/js/monaco/vs/loader.js" type="text/javascript" asp-append-version="true"></script>
    <script asp-src-include="~/js/provider.completion.vb.js" type="text/javascript" asp-append-version="true"></script>
    <script asp-src-include="~/js/bindingHandler.monacoEditor.js" type="text/javascript" asp-append-version="true"></script>
    <script asp-src-include="~/js/editcalculation.js" type="text/javascript" asp-append-version="true"></script>
    <script type="text/javascript">
        var editCalculationElement = document.getElementById("edit-calculation");
        if (editCalculationElement) {
            var editViewModelOptions = {
                calculationId: "@Model.Calculation.Id",
                specificationId: "@Model.SpecificationId",
                existingSourceCode: "@Html.Raw(System.Web.HttpUtility.JavaScriptStringEncode(Model.Calculation.SourceCode))"
            };
            var viewModel = new calculateFunding.editCalculation.EditCalculationViewModel(editViewModelOptions);
            //viewModel.loadIntellisenseContext();
            ko.applyBindings(viewModel, editCalculationElement);
        }

        //var editorVariables = @Html.Raw(Model.VariablesJson);
    </script>
}